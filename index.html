import base64
from graphviz import Digraph

import base64
from graphviz import Digraph

def create_diagram(flow_type):
    dot = Digraph(comment=f'SFCC AM {flow_type} Automation Diagram', format='png')
    dot.attr(rankdir='TB', size='12,12', dpi='300')

    file_color = '#66CCFF'
    jfrog_color = '#33AACC'
    circleci_color = '#343434'
    slack_color = '#4A154B'

    if flow_type == 'CSV/XLSM':
        dot.node('A1', 'XLSM File\n(Input Data & Macros)', shape='box', style='filled', fillcolor=file_color, width='2')
        dot.node('A2', 'CSV File\n(Converted Data)', shape='box', style='filled', fillcolor=file_color, width='2')
        dot.node('A3', 'JFrog\n(Upload CSV)', shape='box', style='filled', fillcolor=jfrog_color, fontcolor='white', width='2')
        dot.node('A4', 'CircleCI\n(Trigger Pipeline)', shape='box', style='filled', fillcolor=circleci_color, fontcolor='white', width='2')
        dot.node('A5', 'Shell Scripts\n(Execute Operations)', shape='box', style='filled', fillcolor=circleci_color, fontcolor='white', width='2')
        dot.node('A6', 'Pipeline Run\n(Response Collection)', shape='box', style='filled', fillcolor=circleci_color, fontcolor='white', width='2')
        dot.node('A7', 'JFrog\n(Upload Response)', shape='box', style='filled', fillcolor=jfrog_color, fontcolor='white', width='2')

        dot.edge('A1', 'A2', 'Generate CSV')
        dot.edge('A2', 'A3', 'Upload CSV')
        dot.edge('A3', 'A4', 'Trigger Pipeline')
        dot.edge('A4', 'A5', 'Execute Scripts')
        dot.edge('A5', 'A6', 'Collect Response')
        dot.edge('A6', 'A7', 'Upload Response')

    elif flow_type == 'Slackbot':
        dot.node('B1', 'Slackbot\n(Command Execution)', shape='box', style='filled', fillcolor=slack_color, fontcolor='white', width='2')
        dot.node('B2', 'CircleCI\n(Trigger Pipeline)', shape='box', style='filled', fillcolor=circleci_color, fontcolor='white', width='2')
        dot.node('B3', 'Shell Scripts\n(Execute Operations)', shape='box', style='filled', fillcolor=circleci_color, fontcolor='white', width='2')
        dot.node('B4', 'Pipeline Run\n(Response Collection)', shape='box', style='filled', fillcolor=circleci_color, fontcolor='white', width='2')
        dot.node('B5', 'Slackbot\n(Return Response)', shape='box', style='filled', fillcolor=slack_color, fontcolor='white', width='2')

        dot.edge('B1', 'B2', 'Pass Operation & Parameters')
        dot.edge('B2', 'B3', 'Execute Scripts')
        dot.edge('B3', 'B4', 'Collect Response')
        dot.edge('B4', 'B5', 'Send Response')

    dot.attr(label=f'SFCC AM {flow_type} Automation Diagram', fontsize='20', labelloc='t')
    return dot

def create_html_content(csv_xlsm_encoded_image, slackbot_encoded_image, csv_xlsm_pointers, slackbot_pointers):
    pointer_html = lambda pointers: "".join([f"""
        <div class="pointer" style="left: {x}%; top: {y}%;">
            <div class="pointer-dot"></div>
            <div class="pointer-text">{i+1}. {text}</div>
        </div>
        """ for i, (x, y, text) in enumerate(pointers)])

    return f"""
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SFCC AM Automation Diagrams</title>
        <style>
            body {{
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f0f0f0;
            }}
            .wrapper {{
                max-width: 1200px;
                margin: 0 auto;
            }}
            .container {{
                background-color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                margin-bottom: 30px;
            }}
            h1, h2 {{
                color: #333;
                text-align: center;
            }}
            .diagram-container {{
                position: relative;
                display: inline-block;
                width: 100%;
            }}
            #diagram {{
                max-width: 100%;
                height: auto;
            }}
            .pointer {{
                position: absolute;
                z-index: 10;
            }}
            .pointer-dot {{
                width: 10px;
                height: 10px;
                background-color: red;
                border-radius: 50%;
                position: absolute;
            }}
            .pointer-text {{
                position: absolute;
                left: 15px;
                top: -5px;
                background-color: rgba(255, 255, 255, 0.8);
                padding: 2px 5px;
                border-radius: 3px;
                font-size: 12px;
                white-space: nowrap;
            }}
        </style>
    </head>
    <body>
        <div class="wrapper">
            <h1>SFCC AM Automation Diagrams</h1>
            
            <div class="container">
                <h2>CSV/XLSM Automation Diagram</h2>
                <div class="diagram-container">
                    <img id="diagram" src="data:image/png;base64,{csv_xlsm_encoded_image}" alt="SFCC AM CSV/XLSM Automation Diagram">
                    {pointer_html(csv_xlsm_pointers)}
                </div>
            </div>

            <div class="container">
                <h2>Slackbot Automation Diagram</h2>
                <div class="diagram-container">
                    <img id="diagram" src="data:image/png;base64,{slackbot_encoded_image}" alt="SFCC AM Slackbot Automation Diagram">
                    {pointer_html(slackbot_pointers)}
                </div>
            </div>
        </div>
    </body>
    </html>
    """

# Create CSV/XLSM diagram
csv_xlsm_dot = create_diagram('CSV/XLSM')
csv_xlsm_png_data = csv_xlsm_dot.pipe(format='png')
csv_xlsm_encoded_image = base64.b64encode(csv_xlsm_png_data).decode('utf-8')

csv_xlsm_pointers = [
    (5, 15, "Input XLSM file with macros"),
    (25, 15, "Generate CSV from XLSM"),
    (45, 15, "Upload CSV to JFrog"),
    (65, 15, "Trigger CircleCI pipeline"),
    (85, 15, "Execute shell scripts"),
    (65, 85, "Collect response"),
    (85, 85, "Upload response to JFrog")
]

# Create Slackbot diagram
slackbot_dot = create_diagram('Slackbot')
slackbot_png_data = slackbot_dot.pipe(format='png')
slackbot_encoded_image = base64.b64encode(slackbot_png_data).decode('utf-8')

slackbot_pointers = [
    (10, 50, "Execute /sfcc-am command"),
    (30, 50, "Pass operation to CircleCI"),
    (50, 50, "Execute shell scripts"),
    (70, 50, "Collect response"),
    (90, 50, "Return response to Slackbot")
]

html_content = create_html_content(csv_xlsm_encoded_image, slackbot_encoded_image, csv_xlsm_pointers, slackbot_pointers)

with open('index.html', 'w') as f:
    f.write(html_content)

print("HTML file with both diagrams saved as 'index.html'")
